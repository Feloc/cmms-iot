generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TECH
  VIEWER
}


model Tenant {
  id         String   @id @default(cuid())
  slug       String   @unique
  name       String
  users      User[]
  assets     Asset[]
  rules      Rule[]
  alerts     Alert[]
  notices    Notice[]
  workOrders WorkOrder[]
  assignments WOAssignment[]
  workLog    WorkLog[]
  inventory  InventoryItem[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  symptomCodes          SymptomCode[]
  causeCodes            CauseCode[]
  remedyCodes           RemedyCode[]
  workOrderResolutions  WorkOrderResolution[]
  workOrderPartUses     WorkOrderPartUsed[]
  workMeasurements      WorkMeasurement[]
  attachments           Attachment[]
  workNotes             WorkNote[]
  assetImportUploads    AssetImportUpload[]
  devices               Device[]
  ruleStates            RuleState[]
  assetEvents           AssetEvent[]
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  email     String
  password  String
  role      Role     @default(ADMIN)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([tenantId, email])
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  DECOMMISSIONED
}

enum AssetCriticality {
  LOW
  MEDIUM
  HIGH
}

model Asset {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])

  code            String
  name            String
  brand           String?
  model           String?
  serialNumber    String?
  nominalPower    Float?
  nominalPowerUnit String?

  status          AssetStatus      @default(ACTIVE)
  criticality     AssetCriticality @default(MEDIUM)

  categoryId      String?
  parentAssetId   String?
  locationId      String?
  supplierId      String?

  slug            String?
  barcode         String?
  qrCodeData      String?
  ingestKey       String?
  assetTopicPrefix String?
  defaultRuleSetId String?

  acquiredOn      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  attachments     Attachment[]
  devices         Device[]
  rules           Rule[]
  assetEvents     AssetEvent[]

  @@unique([tenantId, code])
  @@index([tenantId, name])
  @@index([tenantId, locationId])
  @@index([tenantId, categoryId])
  @@index([tenantId, parentAssetId])
}

// Modelo para almacenar uploads temporales de importación de Assets
model AssetImportUpload {
id            String @id @default(cuid())
tenantId      String
tenant        Tenant @relation(fields: [tenantId], references: [id])

originalName  String
mimeType      String
size          Int
sha256        String
storagePath   String
status ImportStatus @default(PENDING)

createdAt DateTime @default(now())
expiresAt DateTime?

@@index([tenantId, createdAt])
}

enum ImportStatus {
PENDING
COMMITTED
EXPIRED
FAILED
}


model Alert {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  assetCode String
  sensor    String
  kind      String   // THRESHOLD | ROC
  message   String
  status    String   @default("OPEN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  notices   Notice[]
  @@index([tenantId, assetCode, sensor])
}

model Notice {
  id               String         @id @default(cuid())
  tenantId         String
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  source           NoticeSource
  alertId          String?
  alert            Alert?         @relation(fields: [alertId], references: [id])

  assetCode        String
  title            String
  body             String?
  category         NoticeCategory?
  severity         Severity?
  status           NoticeStatus   @default(OPEN)

  createdByUserId  String
  assignedToUserId String?
  dueDate          DateTime?
  startedAt        DateTime?
  resolvedAt       DateTime?
  downtimeMin      Int?
  tags             String[]       @default([])
  attachments      Json?

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  workOrders       WorkOrder[]

  @@index([tenantId, status])
  @@index([tenantId, assetCode, status])
  @@index([tenantId, createdAt])
}

enum NoticeSource { 
  RULE
  MANUAL
  IMPORT 
}
enum NoticeCategory { 
  INCIDENT
  MAINT_LOG
  CONSUMABLE_CHANGE
  INSPECTION
  OTHER 
}
enum NoticeStatus {
  OPEN
  IN_PROGRESS 
  RESOLVED 
  CLOSED 
}
enum Severity { 
  LOW 
  MEDIUM 
  HIGH 
  CRITICAL 
}


model WorkOrder {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  noticeId    String?
  notice      Notice?  @relation(fields: [noticeId], references: [id])

  assetCode   String
  title       String
  description String?
  status      WorkOrderStatus  @default(OPEN)
  priority    WorkOrderPriority?

  dueDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments WOAssignment[]
  workLogs    WorkLog[]
  workOrderResolutions WorkOrderResolution[]
  workOrderPartUses WorkOrderPartUsed[]
  workMeasurements   WorkMeasurement[]
  attachments        Attachment[]
  workNotes          WorkNote[]

  @@index([tenantId, status])
  @@index([tenantId, assetCode, status])
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CLOSED
  CANCELED
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model WOAssignment {
  id           String           @id @default(cuid())
  tenantId     String
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId  String
  workOrder    WorkOrder        @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  userId       String
  role         AssignmentRole   @default(TECHNICIAN)
  state        AssignmentState  @default(ACTIVE)
  note         String?
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([tenantId, workOrderId, state])
  @@index([tenantId, userId, state])
}

enum AssignmentRole {
  TECHNICIAN
  SUPERVISOR
}

enum AssignmentState {
  ACTIVE
  REMOVED
}

model WorkLog {
  id             String         @id @default(cuid())
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId    String
  workOrder      WorkOrder      @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  userId         String
  source         WorkLogSource  @default(MANUAL)
  note           String?

  startedAt      DateTime
  endedAt        DateTime?

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([tenantId, workOrderId])
  @@index([tenantId, userId, startedAt])
}

enum WorkLogSource {
  MANUAL
  IMPORT
  IOT
}

model InventoryItem {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  sku       String
  name      String
  qty       Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([tenantId, sku])
}


/// === Catálogos por tenant ===
model SymptomCode {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code      String
  name      String
  enabled   Boolean  @default(true)
  assetType String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrderResolutios WorkOrderResolution[]

  @@unique([tenantId, code])
}

model CauseCode {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code      String
  name      String
  enabled   Boolean  @default(true)
  assetType String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrderResolutios WorkOrderResolution[]

  @@unique([tenantId, code])
}

model RemedyCode {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code      String
  name      String
  enabled   Boolean  @default(true)
  assetType String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrderResolutios WorkOrderResolution[]

  @@unique([tenantId, code])
}

/// === Desarrollo/Resolución de la OT ===
model WorkOrderResolution {
  id                        String   @id @default(cuid())
  tenantId                  String
  tenant                    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId               String   @unique
  workOrder                 WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  symptomCodeId             String?
  symptomCode               SymptomCode? @relation(fields: [symptomCodeId], references: [id])
  symptomOther              String?

  causeCodeId               String?
  causeCode                 CauseCode?   @relation(fields: [causeCodeId], references: [id])
  causeOther                String?
  rootCauseText             String?

  remedyCodeId              String?
  remedyCode                RemedyCode?  @relation(fields: [remedyCodeId], references: [id])
  remedyOther               String?
  solutionSummary           String?
  preventiveRecommendation  String?

  resolvedByUserId          String?
  resolvedAt                DateTime?
  verifiedByUserId          String?
  verifiedAt                DateTime?
  verificationNotes         String?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([tenantId, workOrderId])
}

/// === Partes usadas ===
model WorkOrderPartUsed {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId   String
  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  inventoryItemId String?
  freeText        String?
  qty             Float
  unitCost        Float?
  totalCost       Float?

  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, workOrderId])
}

/// === Mediciones ===
enum MeasurementPhase {
  BEFORE
  AFTER
  OTHER
}

model WorkMeasurement {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  type        String
  valueNumeric Float?
  valueText    String?
  unit        String?
  phase       MeasurementPhase @default(OTHER)
  takenAt     DateTime @default(now())

  createdByUserId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, workOrderId])
}

/// === Adjuntos ===
model Attachment {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId String?
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  assetId     String?
  asset       Asset?     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type        AttachmentType
  filename    String
  mimeType    String
  size        Int
  url         String
  createdBy   String
  createdAt   DateTime  @default(now())

  @@index([tenantId, workOrderId, createdAt(sort: Desc)])
  @@index([tenantId, assetId, createdAt(sort: Desc)])
}

enum AttachmentType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}


/// === Notas técnicas ===
model WorkNote {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  note        String
  addedByUserId String
  addedAt     DateTime @default(now())

  @@index([tenantId, workOrderId, addedAt])
}


/// 
/// IoT
/// 

enum DeviceType {
  ARDUINO_NANO_33_IOT
  GENERIC_MCU
  EDGE_GATEWAY
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  UNKNOWN
}

enum RuleKind {
  THRESHOLD
  ROC
  WINDOW_AVG
}

enum EventStatus {
  OPEN
  ACK
  CLOSED
}

/// MODELS
model Device {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String
  type       DeviceType
  status     DeviceStatus   @default(UNKNOWN)
  ingestKey  String?        @unique
  assetId    String?
  asset      Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  // Auth simple para MQTT (dev): username = `${tenantSlug}:${deviceId}` o propio
  authMode   String   @default("password") // password | token | external
  username   String?
  secretHash String?  // nunca guardar plain text

  lastSeen   DateTime?
  metadata   Json?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events     AssetEvent[]
  rules      Rule[]

  @@index([tenantId, assetId])
  @@index([tenantId, status, lastSeen])
  @@unique([tenantId, name])
}

model Rule {
  id         String    @id @default(cuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String
  kind       RuleKind
  severity   Severity  @default(MEDIUM)
  enabled    Boolean   @default(true)

  // ámbito de aplicación: por asset o por device (uno de los dos)
  assetId    String?
  asset      Asset?    @relation(fields: [assetId], references: [id], onDelete: SetNull)
  deviceId   String?
  device     Device?   @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  // métrica a evaluar (ej: "rms_g", "temp_c") y parámetros de la regla (JSON)
  metric     String
  params     Json      // { min?:number, max?:number, windowSec?:number, rocLimit?:number, hysteresis?:number, cooldownSec?:number }

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  state      RuleState?
  events     AssetEvent[]

  @@index([tenantId, metric, enabled])
}

model RuleState {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ruleId     String   @unique
  rule       Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  status     String   @default("NORMAL") // NORMAL | ALERTING
  lastChangeAt DateTime @default(now())
  data       Json?
}

model AssetEvent {
  id         String     @id @default(cuid())
  tenantId   String
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  assetId    String
  asset      Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)

  deviceId   String?
  device     Device?    @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  ruleId     String?
  rule       Rule?      @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  message    String
  severity   Severity   @default(MEDIUM)
  status     EventStatus @default(OPEN)

  createdAt  DateTime   @default(now())
  closedAt   DateTime?

  @@index([tenantId, assetId, createdAt(sort: Desc)])
  @@index([tenantId, status, severity, createdAt(sort: Desc)])
}
